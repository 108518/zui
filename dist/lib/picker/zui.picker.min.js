/*!
 * ZUI: 选择器 - v1.9.1 - 2020-05-04
 * http://openzui.com
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2020 cnezsoft.com; Licensed MIT
 */
!function(e,t,i){"use strict";var o="zui.picker",n={},r={lang:null,remote:null,remoteConverter:null,remoteOnly:!1,onRemoteError:null,textKey:"text",valueKey:"value",keysKey:"keys",multi:"auto",formItem:"auto",list:null,allowSingleDeselect:null,hideMultiSelectedOption:!1,autoSelectFirst:!1,optionItemFormatter:null,maxSelectedCount:0,maxListCount:50,searchValueKey:!0,emptyResultHint:null,hideOnWindowScroll:!0,emptySearchResultHint:null,accurateSearchHint:null,remoteErrorHint:null,maxDropHeight:250,dropDirection:"auto",dropWidth:"100%",maxAutoDropWidth:450,multiValueSplitter:",",searchDelay:200,fixLabelFor:!0,hotkey:!0,onSelect:null},s={zh_cn:{emptyResultHint:"没有可选项",emptySearchResultHint:"没有找到 “{0}”",accurateSearchHint:"请提供更多关键词缩小匹配范围",remoteErrorHint:"无法从服务器获取结果 - {0}"},zh_tw:{emptyResultHint:"沒有可選項",emptySearchResultHint:"沒有找到 “{0}”",accurateSearchHint:"請提供更多關鍵詞縮小匹配範圍",remoteErrorHint:"無法從服務器獲取結果 - {0}"},en:{emptyResultHint:"No options",emptySearchResultHint:'Cannot found "{0}"',accurateSearchHint:"Suggest to provide more keywords",remoteErrorHint:"Unable to get result from server: {0}"}},a=function(t,i){var n=this;n.name=o,n.id="pk_"+e.zui.uuid(),n.$=e(t),i=n.options=e.extend({},a.DEFAULTS,this.$.data(),i);var r=e.zui.clientLang?e.zui.clientLang():"en",l=i.lang||r;n.lang=e.zui.getLangData?e.zui.getLangData(o,l,s):s[l]||s[r];var p,c,u=i.formItem,d='.form-item,input[type="hidden"],select,input[type="text"]';if(p="self"===u?n.$:"auto"!==u&&u?n.$.find(u):n.$.is(d)?n.$:n.$.find(d).first(),!p.length)return console.error&&console.error("Cannot found form item for picker.");if(p.is('input[type="hidden"]'))c="hidden";else if(p.is("select"))c="select";else{if(!p.is('input[type="text"]'))return console.error&&console.error("Unknown form type for picker.");c="text"}n.formType=c,n.$formItem=p.removeClass("picker").hide(),n.selfFormItem=p.is(n.$);var v=i.multi;v&&"auto"!==v||(v="select"===c&&"multiple"===p.attr("multiple")),v=!!v,n.multi=v;var h=i.list;h?n.setList("function"==typeof h?h({search:n.search,limit:i.maxListCount}):h,!0):"select"===c?(h=[],p.children("option").each(function(){var t=e(this),o=t.text(),n=t.val();if(o.length||n.length){var r={};r[i.valueKey]=n,r[i.textKey]=o,r[i.keysKey]=t.data(i.keysKey),h.push(r)}null!==i.allowSingleDeselect&&void 0!==i.allowSingleDeselect||n.length||(i.allowSingleDeselect=!0)}),n.setList(h,!0)):n.setList([],!0);var f;f=!n.selfFormItem&&n.$.hasClass("picker")?n.$:e('<div class="picker" />').insertAfter(n.$),f.addClass("picker").toggleClass("picker-multi",v).toggleClass("picker-single",!v);var m=f.children(".picker-selections");m.length?m.empty():m=e('<div class="picker-selections" />');var g=n.id+"-search",y=e('<input id="'+g+'" type="text" class="picker-search">').appendTo(m);if(!v){var k=e('<div class="picker-selection picker-selection-single"><span class="picker-selection-text"></span></div>');i.allowSingleDeselect&&k.append('<span class="picker-selection-remove"></span>'),k.appendTo(m),n.$singleSelection=k}f.append(m),n.$container=f,n.$selections=m,n.$search=y,n.search="";var L=i.placeholder;if(void 0===L&&(L=p.attr("placeholder")),"string"==typeof L&&L.length&&m.append(e('<div class="picker-placeholder" />').text(L)),i.placeholder=L,i.fixLabelFor){var x=p.attr("id");x&&e('label[for="'+x+'"]').attr("for",g)}var S=void 0!==i.defaultValue?i.defaultValue:p.val();n.setValue(S),y.on("focus",function(){f.addClass("picker-focus"),n.showDropList()}).on("blur",function(){f.removeClass("picker-focus")}).on("input change",function(){var e=y.val();v&&y.width(14*e.length),n.tryUpdateList(e)}),i.hotkey&&y.on("keydown",function(e){var t=e.key||e.which;if(n.dropListShowed){var i=n.activeValue,o="string"==typeof i;if("Enter"===t||13===t)o&&(n.select(i),n.multi||y.blur(),e.preventDefault());else if("ArrowDown"===t||40===t){var r,s=n.$activeOption;if(s&&(r=s.next(".picker-option"),n.multi))for(;r.length&&r.hasClass("picker-option-selected");)r=r.next(".picker-option");r&&r.length||(r=n.$optionsList.children(n.multi?".picker-option:not(.picker-option-selected)":".picker-option").first()),r.length&&n.activeOption(r),e.preventDefault()}else if("ArrowUp"===t||30===t){var a,s=n.$activeOption;if(s&&(a=s.prev(".picker-option"),n.multi))for(;a.length&&a.hasClass("picker-option-selected");)a=a.prev(".picker-option");a&&a.length||(a=n.$optionsList.children(n.multi?".picker-option:not(.picker-option-selected)":".picker-option").last()),a.length&&n.activeOption(a),e.preventDefault()}}}),v&&m.on("mousedown",function(e){if(n.dropListShowed)return e.preventDefault(),void e.stopPropagation()}).on("mouseup",function(t){e(t.target).closest(".picker-selection-remove").length||n.dropListShowed||y.focus()}),m.on("click",".picker-selection-remove",function(t){if(n.multi){var i=e(this).closest(".picker-selection");n.deselect(i.data("value"))}else n.deselect();t.stopPropagation()}),i.onCreate&&i.onCreate(n)};a.prototype.select=function(e){var t=this;if(!t.isSelectedValue(e))if(t.multi){var i=t.value;i||(i=[]),i.push(e),t.setValue(i)}else t.setValue(e);t.hideDropList()},a.prototype.deselect=function(e){var t=this;if(t.multi){if(!t.isSelectedValue(e))return;var i=t.value;if(i&&i.length)for(var o=0;o<i.length;++o)if(i[o]===e){i.splice(o,1),t.setValue(i);break}}else t.setValue("")},a.prototype.updateMessage=function(e,t,i){var o=this,n=o.$message,r="string"==typeof e&&e.length;e=r?e:"",n.attr("title",e).text(e).attr("data-type",t),o.$dropMenu.toggleClass("picker-has-message",!!r),i||"top"!==o.dropDirection||o.layoutDropList()},a.prototype.getRemoteList=function(t,i){var o=this,n=o.options.remote;if(n){var r,s={search:o.search,limit:o.options.maxListCount};if(r="string"==typeof n?{url:n}:"function"==typeof n?n(s,o):n,!r.url)return void console.warn("Remote url must provide to get remote list in picker.");r.url=r.url.format(s),o.updateMessage(""),o.$container.addClass("picker-loading"),o.remoteXhr&&o.remoteXhr.abort(),o.remoteXhr=e.ajax(e.extend({dataType:"json",dataFilter:o.options.remoteConverter,data:s},r)).done(function(i,n,r){var s=!1;i&&(e.isPlainObject(i)&&("success"!==i.result&&"ok"!==i.result||!e.isArray(i.data)?o.updateMessage(i.message||JSON.stringify(i),"danger"):i=i.data),e.isArray(i)&&(s=i.length,o.setList(i,o.options.remoteOnly))),t&&t(s)}).fail(function(e,t){var n,r=o.options.onRemoteError;n="function"==typeof r?r(e,t):"string"==typeof r?r:(o.options.remoteErrorHint||o.lang.remoteErrorHint).format(t||""),o.updateMessage(n,"danger"),i&&i()}).always(function(){o.remoteXhr=null,o.$container.removeClass("picker-loading")})}},a.prototype.layoutDropList=function(i,o){var n=this;if(n.$dropMenu){var r=n.options,s=r.maxDropHeight||Number.MAX_VALUE,a=n.$dropMenu;i||a.css({opacity:0,"max-height":s,width:"auto","max-width":"none"}),setTimeout(function(){var i=n.$selections[0].getBoundingClientRect(),l=o?r.dropDirection:n.dropDirection||r.dropDirection,p=r.maxAutoDropWidth,c=e(t),u=c.height(),d=a.height(),v=r.dropWidth||"auto",h={left:i.left,opacity:1};if("auto"===l&&(l=i.top+i.height+d>u&&i.top>u-i.top-i.height?"top":"bottom"),n.dropDirection=l,h.maxHeight=Math.min(s,"bottom"===l?u-i.top-i.height:i.top),d=Math.min(d,h.maxHeight),h.top="bottom"===l?i.top+i.height:i.top-d,"100%"===v)h.width=i.width;else if("auto"===v){if(h.width="auto",h.maxWidth="auto"===p?i.width:p,n.multi){var f=n.$search[0].getBoundingClientRect();h.left=f.left}}else h.width=v;a.css(h)},0)}},a.prototype.tryUpdateList=function(e){var t=this;t.search!==e&&(t.search=e,t.updateListTimer&&clearTimeout(t.updateListTimer),t.updateListTimer=setTimeout(function(){t.updateListTimer=null,t.updateList()},t.options.searchDelay))},a.prototype.renderOptionsList=function(t,i){var o=this,n=o.$optionsList;if(void 0===t?t=o.optionsList:o.optionsList=t,n){var r="",s=o.options,a=o.search,l="string"==typeof a&&a.length;if(t.length){for(var p,c,u,d=s.maxListCount,v=s.valueKey,h=s.textKey,f=s.hideMultiSelectedOption,m=Math.min(t.length,d),g=a.toLowerCase(),y=n.children(".picker-option").addClass("picker-expired"),k=o.activeValue,L=void 0!==k&&null!==k,x=0;x<m;++x){var S=t[x],$=S[v],w=o.isSelectedValue($);if(!(f&&w&&o.multi)){var C=S[h],D=o.getItemID(S,"option"),H=y.find("#"+D);H.length?H.removeClass("picker-expired"):H=e('<a class="picker-option" id="'+D+'" data-value="'+$+'"><span class="picker-option-text"></span><span class="picker-option-keys"></span></a>'),H.attr("title",C).removeClass(".picker-option-active").toggleClass("picker-option-selected",w);var O=H.find(".picker-option-text");if(l){var M=C.toLowerCase(),V=M.split(g);if(V.length>1){O.empty();var I=0,K=V[0].length;K&&(O.append(e("<span>").text(C.substr(I,K))),I+=K);for(var T=1;T<V.length;++T)O.append(e('<span class="picker-option-text-matched">').text(C.substr(I,a.length))),I+=a.length,K=V[T].length,K&&(O.append(e("<span>").text(C.substr(I,K))),I+=K)}else O.text(C)}else O.text(C);H.appendTo(n),o.multi?w||c||(c=S):!u&&L&&$===k?u=S:w?p=S:c||(c=S)}}y.filter(".picker-expired").remove(),!i&&m<t.length&&(r=s.accurateSearchHint||o.lang.accurateSearchHint),o.listRendered||o.activeOption(u||p||c)}else n.empty(),i||(r=l?(s.emptySearchResultHint||o.lang.emptySearchResultHint).format(a):s.emptyResultHint||o.lang.emptyResultHint);i||o.updateMessage(r,"info"),o.$dropMenu.toggleClass("picker-no-options",!t.length),o.layoutDropList(),o.listRendered=!0}},a.prototype.activeOption=function(t){var i=this;if(t&&(t instanceof e?t=t.attr("data-value"):"object"==typeof t&&(t=t[i.options.valueKey])),t!==i.activeValue){var o=i.getListItem(t);o?i.activeValue=t:t=i.activeValue;var n=i.$activeOption;if(n&&n.removeClass("picker-option-active"),n=i.$optionsList.find('[data-value="'+t+'"]'),n.length){n.addClass("picker-option-active");var r=n[0];r.scrollIntoViewIfNeeded?r.scrollIntoViewIfNeeded():r.scrollIntoView&&r.scrollIntoView(),i.$activeOption=n}else i.$activeOption=null}},a.prototype.updateList=function(e,t){var i=this;void 0!==e?i.search=e:e=i.search;var o=i.options.remoteOnly;if(!o){var n=[];if(null===e||void 0===e||"string"==typeof e&&!e.length)n=i.list||[];else if("function"==typeof i.options.list)n=i.options.list({search:e,limit:i.options.maxListCount});else if(i.list&&i.list.length){var r=i.options.maxListCount,s=i.options.keysKey,a=i.options.textKey,l=i.options.valueKey,p=i.options.searchValueKey,c={};e=e.toLowerCase();for(var u=0;u<i.list.length;++u){var d=i.list[u],v=d[l];if(!i.multi||!i.isSelectedValue(v)){var h=0,f=d[a];if(null!==f&&void 0!==f&&""!==f){f=f.toLowerCase();var m=f.indexOf(e);m>-1&&(h+=0===m?20:10)}if(!h){var g=d[s];if(null!==g&&void 0!==g&&""!==g){g=g.toLowerCase();var m=g.indexOf(e);m>-1&&(h+=0===m?8:4)}}if(!h&&p&&null!==v&&void 0!==v&&""!==v){v=v.toLowerCase();var m=v.indexOf(e);m>-1&&(h+=0===m?3:1)}if(h&&(c[v]=h+(i.list.length-u)/i.list.length,n.push(d)),r&&n.length>=r)break}}n.length&&(n=n.sort(function(e,t){return c[t[l]]-c[e[l]]}))}i.renderOptionsList(n)}t||i.getRemoteList(function(t){o?i.renderOptionsList(i.list):i.updateList(e,!0)},o?function(){i.renderOptionsList([],!0)}:null)},a.prototype.showDropList=function(){var t=this;if(t.dropListShowed=!0,t.dropDirection=null,t.listRendered=!1,t.activeValue=null,n[t.id]=t,!t.$dropMenu){var i=e('<div class="picker-drop-menu" id="pickerDropMenu-'+t.id+'"></div>'),r=e('<div class="picker-option-list"></div>').appendTo(i);i.data(o,t).toggleClass("picker-multi",t.multi).toggleClass("picker-single",!t.multi).appendTo("body"),r.on("click",".picker-option",function(){t.select(e(this).attr("data-value"))}).on("mouseenter",".picker-option",function(){t.activeOption(e(this))});var s=e('<div class="picker-message"></div>').appendTo(i);t.$dropMenu=i,t.$message=s,t.$optionsList=r}t.updateList(),t.$dropMenu.addClass("picker-drop-show")},a.prototype.hideDropList=function(){var e=this;e.dropListShowed=!1,e.$search.val(""),e.search="",delete n[e.id],e.$dropMenu&&e.$dropMenu.removeClass("picker-drop-show")},a.prototype.setList=function(t,i){var o=this,n=o.options,r=i?[]:o.list||[],s=i?{}:o.listMap||{};"string"==typeof t&&(t=t.split(","));for(var a=0;a<t.length;++a){var l=t[a];if("string"==typeof l){var p={};p[n.textKey]=l,p[n.valueKey]=String(a),l=p}else if(e.isArray(l)){var p={};p[n.textKey]=l[0],p[n.valueKey]=l[1],p[n.keysKey]=l[2],l=p}var c=l[n.valueKey],u=s[c];u?(l.index=u.$_index,r[u.$_index]=l,s[c]=l):(l.$_index=r.length,s[c]=l,r.push(l))}this.list=r,this.listMap=s},a.prototype.getItemID=function(e,t){var i=this.id+"-item-"+e[this.options.valueKey];return void 0!==t?i+"-"+t:i},a.prototype.isSelectedValue=function(t){var i=this;if(void 0===i.value||null===i.value)return!1;if("string"!=typeof t&&(t=String(t)),i.multi){if(!i.valueSet)if(void 0!==typeof Set)i.valueSet=new Set(i.value);else{i.valueSet={};for(var o=0;o<i.value.length;++o)i.valueSet[i.value[o]]=!0}return e.isPlainObject(i.valueSet)?!!i.valueSet[t]:i.valueSet.has(t)}return t===i.value},a.prototype.getListItem=function(e){return this.listMap[e]},a.prototype.setValue=function(t){var i=this,o=i.options;void 0===t&&(t=i.$formItem.val()),i.multi&&"string"==typeof t?t=t.split(o.multiValueSplitter):i.multi||"string"==typeof t||(t=String(t)),i.value=t,i.multi&&(i.valueSet=null),"select"===i.formType&&(i.$formItem.empty(),i.multi?e.each(t,function(e,t){i.$formItem.append('<option value="'+t+'">')}):i.$formItem.append('<option value="'+t+'">')),i.$formItem.val(t);var n=!1;if(i.multi){var r=i.$selections,s=r.children(".picker-selection").addClass("picker-expired");e.each(t,function(t,r){void 0===r||null===r?r="":"string"!=typeof r&&(r=String(r));var a=i.getListItem(r);if(a){n=!0;var l=a[o.textKey],p=i.getItemID(a,"selection"),c=s.find("#"+p);c.length?c.removeClass("picker-expired"):c=e('<div class="picker-selection" id="'+p+'"><span class="picker-selection-text"></span><span class="picker-selection-remove"></span></div>').data("value",r),c.find(".picker-selection-text").text(l),c.attr("title",l).insertBefore(i.$search)}}),s.filter(".picker-expired").remove()}else{var a=i.getListItem(t);n=!!a,i.$singleSelection.find(".picker-selection-text").text(n?a[o.textKey]:"")}i.$container.toggleClass("picker-no-value",!n).toggleClass("picker-has-value",n),i.dropListShowed&&i.renderOptionsList()},a.prototype.handleWindowScroll=function(){var e=this;e.options.hideOnWindowScroll?(e.scrollEventTimer&&clearTimeout(e.scrollEventTimer),e.$dropMenu.css("opacity",0),e.scrollEventTimer=setTimeout(function(){e.scrollEventTimer=null,e.dropListShowed&&e.layoutDropList(!0,!0)},200)):e.layoutDropList(!0,!0)},a.DEFAULTS=r,e.fn.picker=function(t,i){return this.each(function(){var n=e(this),r=n.data(o),s="object"==typeof t&&t;r||n.data(o,r=new a(this,s)),"string"==typeof t&&r[t](i)})},a.NAME=o,a.SHOWS=n,e.fn.picker.Constructor=a,e(function(){e('[data-toggle="picker"]').picker(),e(i).on("mousedown",function(t){var i=e(t.target).closest(".picker,.picker-drop-menu"),o=i.length;e.each(n,function(e,t){o&&(i.is(t.$container)||t.$dropMenu&&i.is(t.$dropMenu))||t.hideDropList()})}),e(t).on("scroll",function(t){e.each(n,function(e,i){i.handleWindowScroll(t)})})})}(jQuery,window,document);