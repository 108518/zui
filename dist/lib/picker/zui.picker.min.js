/*!
 * ZUI: 选择器 - v1.9.1 - 2020-05-07
 * http://openzui.com
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2020 cnezsoft.com; Licensed MIT
 */
!function(e,t,i){"use strict";var o="zui.picker",n={},r={lang:null,remote:null,remoteConverter:null,remoteOnly:!1,onRemoteError:null,textKey:"text",valueKey:"value",keysKey:"keys",multi:"auto",formItem:"auto",list:null,allowSingleDeselect:null,showMultiSelectedOptions:!1,autoSelectFirst:!1,optionItemFormatter:null,maxSelectedCount:0,maxListCount:50,hideEmptyTextOption:!0,searchValueKey:!0,emptyResultHint:null,hideOnWindowScroll:!0,inheritFormItemClasses:!1,emptySearchResultHint:null,accurateSearchHint:null,remoteErrorHint:null,deleteByBackspace:!0,maxDropHeight:250,dropDirection:"auto",dropWidth:"100%",maxAutoDropWidth:450,multiValueSplitter:",",searchDelay:200,fixLabelFor:!0,hotkey:!0,onSelect:null,onDeselect:null,beforeChange:null,onChange:null,onReady:null,onNoResults:null,onShowingDrop:null,onHidingDrop:null,onShowedDrop:null,onHiddenDrop:null},s={zh_cn:{emptyResultHint:"没有可选项",emptySearchResultHint:"没有找到 “{0}”",accurateSearchHint:"请提供更多关键词缩小匹配范围",remoteErrorHint:"无法从服务器获取结果 - {0}"},zh_tw:{emptyResultHint:"沒有可選項",emptySearchResultHint:"沒有找到 “{0}”",accurateSearchHint:"請提供更多關鍵詞縮小匹配範圍",remoteErrorHint:"無法從服務器獲取結果 - {0}"},en:{emptyResultHint:"No options",emptySearchResultHint:'Cannot found "{0}"',accurateSearchHint:"Suggest to provide more keywords",remoteErrorHint:"Unable to get result from server: {0}"}},l=function(t,i){var n=this;n.name=o,n.id="pk_"+e.zui.uuid(),n.$=e(t),i=n.options=e.extend({},l.DEFAULTS,this.$.data(),i);var r=e.zui.clientLang?e.zui.clientLang():"en",a=i.lang||r;n.lang=e.zui.getLangData?e.zui.getLangData(o,a,s):s[a]||s[r];var p,c,u=i.formItem,d='.form-item,input[type="hidden"],select,input[type="text"]';if(p="self"===u?n.$:"auto"!==u&&u?n.$.find(u):n.$.is(d)?n.$:n.$.find(d).first(),!p.length)return console.error&&console.error("Cannot found form item for picker.");if(p.is('input[type="hidden"]'))c="hidden";else if(p.is("select"))c="select";else{if(!p.is('input[type="text"]'))return console.error&&console.error("Unknown form type for picker.");c="text"}i.inheritFormItemClasses&&f.addClass(p.attr("class")),n.formType=c,n.$formItem=p.removeClass("picker").hide(),n.selfFormItem=p.is(n.$);var h=i.multi;h&&"auto"!==h||(h="select"===c&&"multiple"===p.attr("multiple")),h=!!h,n.multi=h;var v=i.list;v?n.setList("function"==typeof v?v({search:n.search,limit:i.maxListCount}):v,!0):"select"===c?n.updateFromSelect():n.setList([],!0);var f;f=!n.selfFormItem&&n.$.hasClass("picker")?n.$:e('<div class="picker" />').insertAfter(n.$),f.addClass("picker").toggleClass("picker-multi",h).toggleClass("picker-single",!h);var g=f.children(".picker-selections");g.length?g.empty():g=e('<div class="picker-selections" />');var m=n.id+"-search",y=e('<input id="'+m+'" type="text" class="picker-search">').appendTo(g);if(!h){var k=e('<div class="picker-selection picker-selection-single"><span class="picker-selection-text"></span></div>');i.allowSingleDeselect&&k.append('<span class="picker-selection-remove"></span>'),k.appendTo(g),n.$singleSelection=k}f.append(g),n.$container=f,n.$selections=g,n.$search=y,n.search="";var x=i.placeholder;if(void 0===x&&(x=p.attr("placeholder")),"string"==typeof x&&x.length&&g.append(e('<div class="picker-placeholder" />').text(x)),i.placeholder=x,i.fixLabelFor){var L=p.attr("id");L&&e('label[for="'+L+'"]').attr("for",m)}var S=void 0!==i.defaultValue?i.defaultValue:p.val();n.setValue(S,!0),y.on("focus",function(){f.addClass("picker-focus"),n.showDropList()}).on("blur",function(){f.removeClass("picker-focus")}).on("input change",function(){var e=y.val();h&&y.width(14*e.length),n.tryUpdateList(e)}),i.hotkey&&y.on("keydown",function(e){var t=e.key||e.which;if(n.dropListShowed){var i=n.activeValue,o="string"==typeof i;if("Enter"===t||13===t)o&&(n.select(i),n.multi||y.blur(),e.preventDefault());else if("ArrowDown"===t||40===t){var r,s=n.$activeOption;if(s&&(r=s.next(".picker-option"),n.multi))for(;r.length&&r.hasClass("picker-option-selected");)r=r.next(".picker-option");r&&r.length||(r=n.$optionsList.children(n.multi?".picker-option:not(.picker-option-selected)":".picker-option").first()),r.length&&n.activeOption(r),e.preventDefault()}else if("ArrowUp"===t||30===t){var l,s=n.$activeOption;if(s&&(l=s.prev(".picker-option"),n.multi))for(;l.length&&l.hasClass("picker-option-selected");)l=l.prev(".picker-option");l&&l.length||(l=n.$optionsList.children(n.multi?".picker-option:not(.picker-option-selected)":".picker-option").last()),l.length&&n.activeOption(l),e.preventDefault()}}}),h&&g.on("mousedown",function(e){if(n.dropListShowed)return e.preventDefault(),void e.stopPropagation()}).on("mouseup",function(t){e(t.target).closest(".picker-selection-remove").length||n.dropListShowed||n.focus()}),g.on("click",".picker-selection-remove",function(t){if(n.multi){var i=e(this).closest(".picker-selection");n.deselect(i.data("value"))}else n.deselect();t.stopPropagation()}),p.on("chosen:updated",function(){n.updateFromSelect(),n.setValue(p.val()),n.updateList()}).on("chosen:activate",n.focus).on("chosen:open",n.showDropList).on("chosen:close",n.hideDropList),f.addClass("picker-ready"),setTimeout(function(){n.triggerEvent("ready",{picker:n},"","chosen:ready")},0)};l.prototype.focus=function(){this.$search.focus()},l.prototype.select=function(e){var t=this;if(!t.isSelectedValue(e)){if(t.triggerEvent("select",{value:e,picker:t})===!1)return;if(t.multi){var i=t.value;i||(i=[]),i.push(e),t.setValue(i)}else t.setValue(e)}t.hideDropList()},l.prototype.deselect=function(e){var t=this;if(t.multi){if(!t.isSelectedValue(e))return;if(t.triggerEvent("deselect",{value:e,picker:t})===!1)return;var i=t.value;if(i&&i.length)for(var o=0;o<i.length;++o)if(i[o]===e){i.splice(o,1),t.setValue(i);break}}else t.setValue("")},l.prototype.updateMessage=function(e,t,i){var o=this,n=o.$message,r="string"==typeof e&&e.length;e=r?e:"",o.hasMessage=r,n.attr("title",e).text(e).attr("data-type",t),o.$dropMenu.toggleClass("picker-has-message",!!r),i||"top"!==o.dropDirection||o.layoutDropList()},l.prototype.getRemoteList=function(t,i){var o=this,n=o.options.remote;if(n){var r,s={search:o.search,limit:o.options.maxListCount};if(r="string"==typeof n?{url:n}:"function"==typeof n?n(s,o):n,!r.url)return void console.warn("Remote url must provide to get remote list in picker.");r.url=r.url.format(s),o.updateMessage(""),o.$container.addClass("picker-loading"),o.remoteXhr&&o.remoteXhr.abort(),o.remoteXhr=e.ajax(e.extend({dataType:"json",dataFilter:o.options.remoteConverter,data:s},r)).done(function(i,n,r){var s=!1;i&&(e.isPlainObject(i)&&("success"!==i.result&&"ok"!==i.result||!e.isArray(i.data)?o.updateMessage(i.message||JSON.stringify(i),"danger"):i=i.data),e.isArray(i)&&(s=i.length,o.setList(i,o.options.remoteOnly))),t&&t(s)}).fail(function(e,t){var n,r=o.options.onRemoteError;n="function"==typeof r?r(e,t):"string"==typeof r?r:(o.options.remoteErrorHint||o.lang.remoteErrorHint).format(t||""),o.updateMessage(n,"danger"),i&&i()}).always(function(){o.remoteXhr=null,o.$container.removeClass("picker-loading")})}},l.prototype.layoutDropList=function(i,o,n){var r=this;if(r.$dropMenu){var s=r.options,l=s.maxDropHeight||Number.MAX_VALUE,a=r.$dropMenu,p=r.$optionsList;i||(a.css({opacity:0,width:"auto","max-width":"none"}),p.css({"max-height":l})),setTimeout(function(){var i=r.$selections[0].getBoundingClientRect(),c=o?s.dropDirection:r.dropDirection||s.dropDirection;"function"==typeof c&&(c=c(i,r));var u=s.maxAutoDropWidth,d=e(t),h=d.height(),v=a.height(),f=s.dropWidth||"auto",g={left:i.left,opacity:1};"auto"===c&&(c=i.top+i.height+v>h&&i.top>h-i.top-i.height?"top":"bottom"),r.dropDirection=c;var m=Math.min(l,"bottom"===c?h-i.top-i.height:i.top);if(v=Math.min(v,m),g.top="bottom"===c?i.top+i.height:i.top-v,"100%"===f)g.width=i.width;else if("auto"===f){if(g.width="auto",g.maxWidth="auto"===u?i.width:u,r.multi){var y=r.$search[0].getBoundingClientRect();g.left=y.left}}else g.width=f;var k=r.hasMessage?r.$message.outerHeight():0;p.css("max-height",v-k),a.css(g),n&&n()},0)}},l.prototype.tryUpdateList=function(e){var t=this;t.search!==e&&(t.search=e,t.updateListTimer&&clearTimeout(t.updateListTimer),t.updateListTimer=setTimeout(function(){t.updateListTimer=null,t.updateList()},t.options.searchDelay))},l.prototype.renderOptionsList=function(t,i){var o=this,n=o.$optionsList;if(void 0===t?t=o.optionsList:o.optionsList=t,n){var r="",s=o.options,l=o.search,a="string"==typeof l&&l.length;if(t.length){for(var p,c,u,d=s.maxListCount,h=s.valueKey,v=s.textKey,f=s.showMultiSelectedOptions,g=Math.min(t.length,d),m=l.toLowerCase(),y=n.children(".picker-option").addClass("picker-expired"),k=o.activeValue,x=void 0!==k&&null!==k,L=0;L<g;++L){var S=t[L],w=S[h],C=o.isSelectedValue(w);if(f||!C||!o.multi){var $=S[v];if(w.length&&(!s.hideEmptyTextOption||$.length)){var D=o.getItemID(S,"option"),M=y.find("#"+D);M.length?M.removeClass("picker-expired"):M=e('<a class="picker-option" id="'+D+'" data-value="'+w+'"><span class="picker-option-text"></span><span class="picker-option-keys"></span></a>'),M.attr("title",$).removeClass(".picker-option-active").toggleClass("picker-option-selected",C);var O=M.find(".picker-option-text");if(a){var _=$.toLowerCase(),H=_.split(m);if(H.length>1){O.empty();var V=0,b=H[0].length;b&&(O.append(e("<span>").text($.substr(V,b))),V+=b);for(var E=1;E<H.length;++E)O.append(e('<span class="picker-option-text-matched">').text($.substr(V,l.length))),V+=l.length,b=H[E].length,b&&(O.append(e("<span>").text($.substr(V,b))),V+=b)}else O.text($)}else O.text($);M.appendTo(n),o.multi?C||c||(c=S):!u&&x&&w===k?u=S:C?p=S:c||(c=S)}}}y.filter(".picker-expired").remove(),!i&&g<t.length&&(r=s.accurateSearchHint||o.lang.accurateSearchHint),o.listRendered||o.activeOption(u||p||c)}else n.empty(),i||(r=a?(s.emptySearchResultHint||o.lang.emptySearchResultHint).format(l):s.emptyResultHint||o.lang.emptyResultHint,a&&o.triggerEvent("noResults",{search:l,picker:o},"","chosen:no_results"));i||o.updateMessage(r,"info"),o.$dropMenu.toggleClass("picker-no-options",!t.length),o.layoutDropList(),o.listRendered=!0}},l.prototype.activeOption=function(t,i){var o=this;if(t&&(t instanceof e?t=t.attr("data-value"):"object"==typeof t&&(t=t[o.options.valueKey])),t!==o.activeValue){var n=o.getListItem(t);n?o.activeValue=t:t=o.activeValue;var r=o.$activeOption;if(r&&r.removeClass("picker-option-active"),r=o.$optionsList.find('[data-value="'+t+'"]'),r.length){if(r.addClass("picker-option-active"),!i){var s=r[0];s.scrollIntoViewIfNeeded?s.scrollIntoViewIfNeeded():s.scrollIntoView&&s.scrollIntoView()}o.$activeOption=r}else o.$activeOption=null}},l.prototype.updateList=function(e,t,i){var o=this;void 0!==e?o.search=e:e=o.search;var n=o.options.remoteOnly;if(!n){var r=[];if(null===e||void 0===e||"string"==typeof e&&!e.length)r=o.list||[];else if("function"==typeof o.options.list)r=o.options.list({search:e,limit:o.options.maxListCount});else if(o.list&&o.list.length){var s=o.options.maxListCount,l=o.options.keysKey,a=o.options.textKey,p=o.options.valueKey,c=o.options.searchValueKey,u={};e=e.toLowerCase();for(var d=0;d<o.list.length;++d){var h=o.list[d],v=h[p];if(!o.multi||!o.isSelectedValue(v)){var f=0,g=h[a];if(null!==g&&void 0!==g&&""!==g){g=g.toLowerCase();var m=g.indexOf(e);m>-1&&(f+=0===m?20:10)}if(!f){var y=h[l];if(null!==y&&void 0!==y&&""!==y){y=y.toLowerCase();var m=y.indexOf(e);m>-1&&(f+=0===m?8:4)}}if(!f&&c&&null!==v&&void 0!==v&&""!==v){v=v.toLowerCase();var m=v.indexOf(e);m>-1&&(f+=0===m?3:1)}if(f&&(u[v]=f+(o.list.length-d)/o.list.length,r.push(h)),s&&r.length>=s)break}}r.length&&(r=r.sort(function(e,t){return u[t[p]]-u[e[p]]}))}o.renderOptionsList(r,!1,i)}t||o.getRemoteList(function(t){n?o.renderOptionsList(o.list,!1,i):o.updateList(e,!0)},n?function(){o.renderOptionsList([],!0,i)}:null)},l.prototype.showDropList=function(){var t=this;if(t.triggerEvent("showingDrop",{picker:t})!==!1){if(t.dropListShowed=!0,t.dropDirection=null,t.listRendered=!1,t.activeValue=null,n[t.id]=t,!t.$dropMenu){var i=e('<div class="picker-drop-menu" id="pickerDropMenu-'+t.id+'"></div>'),r=e('<div class="picker-option-list"></div>').appendTo(i);i.data(o,t).toggleClass("picker-multi",t.multi).toggleClass("picker-single",!t.multi).appendTo("body"),t.options.chosenMode&&i.addClass("chosen-up"),r.on("click",".picker-option",function(){t.select(e(this).attr("data-value"))}).on("mouseenter",".picker-option",function(){t.activeOption(e(this),!0)});var s=e('<div class="picker-message"></div>').appendTo(i);t.$dropMenu=i,t.$message=s,t.$optionsList=r}t.updateList(t.search,!1,function(){t.triggerEvent("showedDrop",{picker:t},"","chosen:showing_dropdown")}),t.$dropMenu.addClass("picker-drop-show")}},l.prototype.hideDropList=function(){var e=this;e.triggerEvent("hidingDrop",{picker:e})!==!1&&(e.dropListShowed=!1,e.$search.val(""),e.search="",delete n[e.id],e.$dropMenu&&e.$dropMenu.removeClass("picker-drop-show"),e.triggerEvent("hiddenDrop",{picker:e},"","chosen:hiding_dropdown"))},l.prototype.updateFromSelect=function(t){var i=this,o=i.options,n=[];void 0===t&&(t=!0),i.$formItem.children("option").each(function(){var t=e(this),i=t.text(),r=t.val();if(i.length||r.length){var s={};s[o.valueKey]=r,s[o.textKey]=i,s[o.keysKey]=t.data(o.keysKey),n.push(s)}null!==o.allowSingleDeselect&&void 0!==o.allowSingleDeselect||r.length||(o.allowSingleDeselect=!0)}),i.setList(n,t)},l.prototype.setList=function(t,i){var o=this,n=o.options,r=i?[]:o.list||[],s=i?{}:o.listMap||{};"string"==typeof t&&(t=t.split(","));for(var l=0;l<t.length;++l){var a=t[l];if("string"==typeof a){var p={};p[n.textKey]=a,p[n.valueKey]=String(l),a=p}else if(e.isArray(a)){var p={};p[n.textKey]=a[0],p[n.valueKey]=a[1],p[n.keysKey]=a[2],a=p}var c=a[n.valueKey],u=s[c];u?(a.index=u.$_index,r[u.$_index]=a,s[c]=a):(a.$_index=r.length,s[c]=a,r.push(a))}this.list=r,this.listMap=s},l.prototype.getItemID=function(e,t){var i=this.id+"-item-"+e[this.options.valueKey];return void 0!==t?i+"-"+t:i},l.prototype.isSelectedValue=function(t){var i=this;if(void 0===i.value||null===i.value)return!1;if("string"!=typeof t&&(t=String(t)),i.multi){if(!i.valueSet)if(void 0!==typeof Set)i.valueSet=new Set(i.value);else{i.valueSet={};for(var o=0;o<i.value.length;++o)i.valueSet[i.value[o]]=!0}return e.isPlainObject(i.valueSet)?!!i.valueSet[t]:i.valueSet.has(t)}return t===i.value},l.prototype.getListItem=function(e){return this.listMap[e]},l.prototype.triggerEvent=function(t,i,o,n){var r=this;if(e.isArray(i)||(i=[i]),r.$.trigger(t,i),r.options.chosenMode&&n&&r.$.trigger(n,i),o=o===!0?t:o||"on"+t[0].toUpperCase()+t.substr(1),e.isFunction(r.options[o]))return r.options[o].apply(r,i)},l.prototype.setValue=function(t,i){var o=this,n=o.options;if(void 0===t&&(t=o.$formItem.val()),o.multi&&"string"==typeof t?t=t.split(n.multiValueSplitter):o.multi||"string"==typeof t||(t=String(t)),o.value!==t){if(!i&&o.triggerEvent("beforeChange",{value:t,oldValue:o.value},!0)===!1)return;o.value=t,n.onChange&&n.onChange(t),i||o.triggerEvent("change",{picker:o})}o.multi&&(o.valueSet=null);var r=o.$formItem;if("select"===o.formType){var s=n.chosenMode;s||r.empty(),o.multi?e.each(t,function(e,t){s&&r.find('option[value="'+t+'"]').length||r.append('<option value="'+t+'">')}):s&&r.find('option[value="'+t+'"]').length||r.append('<option value="'+t+'">')}r.val(t);var l=!1;if(o.multi){var a=o.$selections,p=a.children(".picker-selection").addClass("picker-expired");e.each(t,function(t,i){void 0===i||null===i?i="":"string"!=typeof i&&(i=String(i));var r=o.getListItem(i);if(r){l=!0;var s=r[n.textKey],a=o.getItemID(r,"selection"),c=p.find("#"+a);c.length?c.removeClass("picker-expired"):c=e('<div class="picker-selection" id="'+a+'"><span class="picker-selection-text"></span><span class="picker-selection-remove"></span></div>').data("value",i),c.find(".picker-selection-text").text(s),c.attr("title",s).insertBefore(o.$search)}}),p.filter(".picker-expired").remove()}else{var c=o.getListItem(t);l=!!c,o.$singleSelection.find(".picker-selection-text").text(l?c[n.textKey]:"")}o.$container.toggleClass("picker-no-value",!l).toggleClass("picker-has-value",l),o.dropListShowed&&o.renderOptionsList()},l.prototype.handleWindowScroll=function(){var e=this;e.options.hideOnWindowScroll?(e.scrollEventTimer&&clearTimeout(e.scrollEventTimer),e.$dropMenu.css("opacity",0),e.scrollEventTimer=setTimeout(function(){e.scrollEventTimer=null,e.dropListShowed&&e.layoutDropList(!0,!0)},500)):e.layoutDropList(!0,!0)},l.DEFAULTS=r,l.NAME=o,l.SHOWS=n,l.convertChosenOptions=function(t){var i=!1;return e.each({allow_single_deselect:"allowSingleDeselect",inherit_select_classes:"inheritFormItemClasses",max_selected_options:"maxSelectedCount",no_results_text:"emptySearchResultHint",placeholder_text:"placeholder",placeholder_text_multiple:"placeholder",placeholder_text_single:"placeholder",single_backstroke_delete:"deleteByBackspace",display_selected_options:"showMultiSelectedOptions",drop_direction:"dropDirection",drop_width:"dropWidth",max_drop_width:"maxAutoDropWidth",highlight_selected:"autoSelectFirst",sort_value_splitter:"multiValueSplitter"},function(e,o){var n=t[e];void 0!==n&&(t[o]=n,delete t[e],i=!0)}),i&&(t.chosenMode=!0),t},e.fn.picker=function(t,i){return this.each(function(){var n=e(this),r=n.data(o),s="object"==typeof t&&t;r?"string"==typeof t&&r[t](i):((l.enabledChosenMode||s&&s.chosenMode)&&(s=l.convertChosenOptions(e.extend({},n.data(),s))),n.data(o,r=new l(this,s)))})},e.fn.picker.Constructor=l,e.Picker=e.zui.Picker=l,l.enableChosen=function(){l.enabledChosenMode||(e.fn.chosen=function(t,i){return this.each(function(){var n=e(this),r=n.data(o);if(!r){var s=e.extend({},n.data(),"object"==typeof t?t:null);return r=new l(this,l.convertChosenOptions(s)),void n.data(o,r)}"string"==typeof t&&r[t](i)})},e.fn._chosen=e.fn.chosen,l.enabledChosenMode=!0)},e(function(){e('[data-toggle="picker"]').picker(),e(i).on("mousedown",function(t){var i=e(t.target).closest(".picker,.picker-drop-menu"),o=i.length;e.each(n,function(e,t){o&&(i.is(t.$container)||t.$dropMenu&&i.is(t.$dropMenu))||t.hideDropList()})}),e(t).on("scroll",function(t){e.each(n,function(e,i){i.handleWindowScroll(t)})})})}(jQuery,window,document);