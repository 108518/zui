/*!
 * ZUI: 选择器 - v1.9.1 - 2020-05-04
 * http://openzui.com
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2020 cnezsoft.com; Licensed MIT
 */
!function(e,t,i){"use strict";var o="zui.picker",r={lang:null,remote:null,remoteConverter:null,remoteOnly:!1,onRemoteError:null,textKey:"text",valueKey:"value",keysKey:"keys",multi:"auto",formItem:"auto",list:null,allowSingleDeselect:null,hideMultiSelectedOption:!1,autoSelectFirst:!1,optionItemFormatter:null,maxSelectedCount:0,maxListCount:50,searchValueKey:!0,emptyResultHint:null,emptySearchResultHint:null,accurateSearchHint:null,remoteErrorHint:null,placeholder:null,maxDropHeight:250,dropDirection:"auto",dropWidth:"100%",maxAutoDropWidth:450,multiValueSplitter:",",searchDelay:200,fixLabelFor:!0,onSelect:null},n={zh_cn:{emptyResultHint:"没有可选项",emptySearchResultHint:"没有找到 “{0}”",accurateSearchHint:"请提供更多关键词缩小匹配范围",remoteErrorHint:"无法从服务器获取结果 - {0}"},zh_tw:{emptyResultHint:"沒有可選項",emptySearchResultHint:"沒有找到 “{0}”",accurateSearchHint:"請提供更多關鍵詞縮小匹配範圍",remoteErrorHint:"無法從服務器獲取結果 - {0}"},en:{emptyResultHint:"No options",emptySearchResultHint:'Cannot found "{0}"',accurateSearchHint:"Suggest to provide more keywords",remoteErrorHint:"Unable to get result from server: {0}"}},s=function(t,r){var a=this;a.name=o,a.id="pk_"+e.zui.uuid(),a.$=e(t),r=a.options=e.extend({},s.DEFAULTS,this.$.data(),r);var l=e.zui.clientLang?e.zui.clientLang():"en",p=r.lang||l;a.lang=e.zui.getLangData?e.zui.getLangData(o,p,n):n[p]||n[l];var u,c,d=r.formItem,h='.form-item,input[type="hidden"],select,input[type="text"]';if(u="self"===d?a.$:"auto"!==d&&d?a.$.find(d):a.$.is(h)?a.$:a.$.find(h).first(),!u.length)return console.error&&console.error("Cannot found form item for picker.");if(u.is('input[type="hidden"]'))c="hidden";else if(u.is("select"))c="select";else{if(!u.is('input[type="text"]'))return console.error&&console.error("Unknown form type for picker.");c="text"}a.formType=c,a.$formItem=u.removeClass("picker").hide(),a.selfFormItem=u.is(a.$);var f=r.multi;f&&"auto"!==f||(f="select"===c&&"multiple"===u.attr("multiple")),f=!!f,a.multi=f;var m=r.list;m?a.setList("function"==typeof m?m({search:a.search,limit:r.maxListCount}):m,!0):"select"===c?(m=[],u.children("option").each(function(){var t=e(this),i=t.text(),o=t.val();if(i.length||o.length){var n={};n[r.valueKey]=o,n[r.textKey]=i,n[r.keysKey]=t.data(r.keysKey),m.push(n)}null!==r.allowSingleDeselect&&void 0!==r.allowSingleDeselect||o.length||(r.allowSingleDeselect=!0)}),a.setList(m,!0)):a.setList([],!0);var v;v=!a.selfFormItem&&a.$.hasClass("picker")?a.$:e('<div class="picker" />').insertAfter(a.$),v.addClass("picker").toggleClass("picker-multi",f).toggleClass("picker-single",!f);var g=v.children(".picker-selections");g.length?g.empty():g=e('<div class="picker-selections" />');var y=a.id+"-search",k=e('<input id="'+y+'" type="text" class="picker-search">').appendTo(g);if(!f){var x=e('<div class="picker-selection picker-selection-single"><span class="picker-selection-text"></span></div>');r.allowSingleDeselect&&x.append('<span class="picker-selection-remove"></span>'),x.appendTo(g),a.$singleSelection=x}if(v.append(g),a.$container=v,a.$selections=g,a.$search=k,a.search="",r.fixLabelFor){var L=u.attr("id");L&&e('label[for="'+L+'"]').attr("for",y)}var S=void 0!==r.defaultValue?r.defaultValue:u.val();a.setValue(S),k.on("focus",function(){v.addClass("picker-focus"),a.showDropList()}).on("blur",function(){v.removeClass("picker-focus")}).on("input change",function(){var e=k.val();f&&k.width(14*e.length),a.tryUpdateList(e)}),f&&g.on("mousedown",function(e){if(a.dropListShowed)return e.preventDefault(),void e.stopPropagation()}).on("mouseup",function(t){e(t.target).closest(".picker-selection-remove").length||a.dropListShowed||k.focus()}),g.on("click",".picker-selection-remove",function(t){if(a.multi){var i=e(this).closest(".picker-selection");a.deselect(i.attr("data-value"))}else a.deselect();t.stopPropagation()}),e(i).on("mousedown",function(t){var i=e(t.target).closest(".picker,.picker-drop-menu");i.length&&(i.is(a.$container)||a.$dropMenu&&i.is(a.$dropMenu))||a.hideDropList()}),console.log("Picker",a)};s.prototype.select=function(e){var t=this;if(!t.isSelectedValue(e))if(t.multi){var i=t.value;i||(i=[]),i.push(e),t.setValue(i)}else t.setValue(e);t.hideDropList()},s.prototype.deselect=function(e){var t=this;if(t.multi){if(!t.isSelectedValue(e))return;var i=t.value;if(i&&i.length)for(var o=0;o<i.length;++o)if(i[o]===e){i.splice(o,1),t.setValue(i);break}}else t.setValue("")},s.prototype.updateMessage=function(e,t,i){var o=this,r=o.$message,n="string"==typeof e&&e.length;e=n?e:"",r.attr("title",e).text(e).attr("data-type",t),o.$dropMenu.toggleClass("picker-has-message",!!n),i||"top"!==o.dropDirection||o.layoutDropList()},s.prototype.getRemoteList=function(t,i){var o=this,r=o.options.remote;if(r){var n,s={search:o.search,limit:o.options.maxListCount};if(n="string"==typeof r?{url:r}:"function"==typeof r?r(s,o):r,!n.url)return void console.warn("Remote url must provide to get remote list in picker.");n.url=n.url.format(s),o.updateMessage(""),o.$container.addClass("picker-loading"),o.remoteXhr&&o.remoteXhr.abort(),o.remoteXhr=e.ajax(e.extend({dataType:"json",dataFilter:o.options.remoteConverter,data:s},n)).done(function(i,r,n){var s=!1;i&&(e.isPlainObject(i)&&("success"!==i.result&&"ok"!==i.result||!e.isArray(i.data)?o.updateMessage(i.message||JSON.stringify(i),"danger"):i=i.data),e.isArray(i)&&(s=i.length,o.setList(i,o.options.remoteOnly))),t&&t(s)}).fail(function(e,t){var r,n=o.options.onRemoteError;r="function"==typeof n?n(e,t):"string"==typeof n?n:(o.options.remoteErrorHint||o.lang.remoteErrorHint).format(t||""),o.updateMessage(r,"danger"),i&&i()}).always(function(){o.remoteXhr=null,o.$container.removeClass("picker-loading")})}},s.prototype.layoutDropList=function(){var i=this;if(i.$dropMenu){var o=i.options,r=o.maxDropHeight||Number.MAX_VALUE,n=i.$dropMenu.css({opacity:0,"max-height":r,width:"auto","max-width":"none"});setTimeout(function(){var s=i.dropDirection||o.dropDirection,a=o.maxAutoDropWidth,l=e(t),p=i.$selections[0].getBoundingClientRect(),u=n.height(),c=o.dropWidth||"auto",d=l.height(),h={left:p.left,opacity:1};"auto"===s&&(s=p.top+p.height+u>d&&p.top>d-p.top-p.height?"top":"bottom"),i.dropDirection=s,h.maxHeight=Math.min(r,"bottom"===s?d-p.top-p.height:p.top),u=Math.min(u,h.maxHeight),h.top="bottom"===s?p.top+p.height:p.top-u,"100%"===c?h.width=p.width:"auto"===c?(h.width="auto",h.maxWidth="auto"===a?p.width:a):h.width=c,n.css(h)},0)}},s.prototype.tryUpdateList=function(e){var t=this;t.search!==e&&(t.search=e,t.updateListTimer&&clearTimeout(t.updateListTimer),t.updateListTimer=setTimeout(function(){t.updateListTimer=null,t.updateList()},t.options.searchDelay))},s.prototype.renderOptionsList=function(t,i){var o=this,r=o.$optionsList;if(void 0===t?t=o.optionsList:o.optionsList=t,r){var n="",s="",a=o.options,l=o.search,p="string"==typeof l&&l.length;if(t.length){for(var u=a.maxListCount,c=a.valueKey,d=a.textKey,h=a.hideMultiSelectedOption,f=Math.min(t.length,u),m=l.toLowerCase(),v=r.children(".picker-option").addClass("picker-expired"),g=0;g<f;++g){var y=t[g],k=y[c],x=o.isSelectedValue(k);if(!(h&&x&&o.multi)){var L=y[d],S=o.getItemID(y,"option"),$=v.find("#"+S);$.length?$.removeClass("picker-expired"):$=e('<a class="picker-option" id="'+S+'" data-value="'+k+'"><span class="picker-option-text"></span><span class="picker-option-keys"></span></a>'),$.attr("title",L).toggleClass("picker-option-selected",x);var C=$.find(".picker-option-text");if(p){var w=L.toLowerCase(),D=w.split(m);if(D.length>1){C.empty();var H=0,M=D[0].length;M&&(C.append(e("<span>").text(L.substr(H,M))),H+=M);for(var K=1;K<D.length;++K)C.append(e('<span class="picker-option-text-matched">').text(L.substr(H,l.length))),H+=l.length,M=D[K].length,M&&(C.append(e("<span>").text(L.substr(H,M))),H+=M)}else C.text(L)}else C.text(L);$.appendTo(r)}}v.filter(".picker-expired").remove(),!i&&f<t.length&&(n=a.accurateSearchHint||o.lang.accurateSearchHint)}else r.empty(),i||(n=p?(a.emptySearchResultHint||o.lang.emptySearchResultHint).format(l):a.emptyResultHint||o.lang.emptyResultHint,s="danger");i||o.updateMessage(n,s),o.$dropMenu.toggleClass("picker-no-options",!t.length),o.layoutDropList()}},s.prototype.updateList=function(e,t){var i=this;void 0!==e?i.search=e:e=i.search;var o=i.options.remoteOnly;if(!o){var r=[];if(null===e||void 0===e||"string"==typeof e&&!e.length)r=i.list||[];else if("function"==typeof i.options.list)r=i.options.list({search:e,limit:i.options.maxListCount});else if(i.list&&i.list.length){var n=i.options.maxListCount,s=i.options.keysKey,a=i.options.textKey,l=i.options.valueKey,p=i.options.searchValueKey,u={};e=e.toLowerCase();for(var c=0;c<i.list.length;++c){var d=i.list[c],h=d[l];if(!i.multi||!i.isSelectedValue(h)){var f=0,m=d[a];if(null!==m&&void 0!==m&&""!==m){m=m.toLowerCase();var v=m.indexOf(e);v>-1&&(f+=0===v?20:10)}if(!f){var g=d[s];if(null!==g&&void 0!==g&&""!==g){g=g.toLowerCase();var v=g.indexOf(e);v>-1&&(f+=0===v?8:4)}}if(!f&&p&&null!==h&&void 0!==h&&""!==h){h=h.toLowerCase();var v=h.indexOf(e);v>-1&&(f+=0===v?3:1)}if(f&&(u[h]=f+(i.list.length-c)/i.list.length,r.push(d)),n&&r.length>=n)break}}r.length&&(r=r.sort(function(e,t){return u[t[l]]-u[e[l]]}))}i.renderOptionsList(r)}t||i.getRemoteList(function(t){o?i.renderOptionsList(i.list):i.updateList(e,!0)},o?function(){i.renderOptionsList([],!0)}:null)},s.prototype.showDropList=function(){var t=this;if(t.dropListShowed=!0,t.dropDirection=null,!t.$dropMenu){var i=e('<div class="picker-drop-menu" id="pickerDropMenu-'+t.id+'"></div>'),r=e('<div class="picker-option-list"></div>').appendTo(i);i.data(o,t).toggleClass("picker-multi",t.multi).toggleClass("picker-single",!t.multi).appendTo("body"),r.on("click",".picker-option",function(){t.select(e(this).attr("data-value"))});var n=e('<div class="picker-message"></div>').appendTo(i);t.$dropMenu=i,t.$message=n,t.$optionsList=r}t.updateList(),t.$dropMenu.addClass("picker-drop-show")},s.prototype.hideDropList=function(){var e=this;e.dropListShowed=!1,e.$search.val(""),e.search="",e.$dropMenu&&e.$dropMenu.removeClass("picker-drop-show")},s.prototype.setList=function(t,i){var o=this,r=o.options,n=i?[]:o.list||[],s=i?{}:o.listMap||{};"string"==typeof t&&(t=t.split(","));for(var a=0;a<t.length;++a){var l=t[a];if("string"==typeof l){var p={};p[r.textKey]=l,p[r.valueKey]=String(a),l=p}else if(e.isArray(l)){var p={};p[r.textKey]=l[0],p[r.valueKey]=l[1],p[r.keysKey]=l[2],l=p}var u=l[r.valueKey],c=s[u];c?(l.index=c.$_index,n[c.$_index]=l,s[u]=l):(l.$_index=n.length,s[u]=l,n.push(l))}this.list=n,this.listMap=s},s.prototype.getItemID=function(e,t){var i=this.id+"-item-"+e[this.options.valueKey];return void 0!==t?i+"-"+t:i},s.prototype.isSelectedValue=function(t){var i=this;if(void 0===i.value||null===i.value)return!1;if("string"!=typeof t&&(t=String(t)),i.multi){if(!i.valueSet)if(void 0!==typeof Set)i.valueSet=new Set(i.value);else{i.valueSet={};for(var o=0;o<i.value.length;++o)i.valueSet[i.value[o]]=!0}return e.isPlainObject(i.valueSet)?!!i.valueSet[t]:i.valueSet.has(t)}return t===i.value},s.prototype.getListItem=function(e){return this.listMap[e]},s.prototype.setValue=function(t){console.log("setValue",t);var i=this,o=i.options;void 0===t&&(t=i.$formItem.val()),i.multi&&"string"==typeof t?t=t.split(o.multiValueSplitter):i.multi||"string"==typeof t||(t=String(t)),i.value=t,i.multi&&(i.valueSet=null),"select"===i.formType&&(i.$formItem.empty(),i.multi?e.each(t,function(e,t){i.$formItem.append('<option value="'+t+'">')}):i.$formItem.append('<option value="'+t+'">')),i.$formItem.val(t);var r=!1;if(i.multi){var n=i.$selections,s=n.children(".picker-selection").addClass("picker-expired");e.each(t,function(t,n){void 0===n||null===n?n="":"string"!=typeof n&&(n=String(n));var a=i.getListItem(n);if(a){r=!0;var l=a[o.textKey],p=i.getItemID(a,"selection"),u=s.find("#"+p);u.length?u.removeClass("picker-expired"):u=e('<div class="picker-selection" id="'+p+'" data-value="'+n+'"><span class="picker-selection-text"></span><span class="picker-selection-remove"></span></div>'),u.find(".picker-selection-text").text(l),u.attr("title",l).insertBefore(i.$search)}}),s.filter(".picker-expired").remove()}else{var a=i.getListItem(t);r=!!a,i.$singleSelection.find(".picker-selection-text").text(r?a[o.textKey]:"")}i.$container.toggleClass("picker-no-value",!r).toggleClass("picker-has-value",r),i.dropListShowed&&i.renderOptionsList()},s.DEFAULTS=r,e.fn.picker=function(t,i){return this.each(function(){var r=e(this),n=r.data(o),a="object"==typeof t&&t;n||r.data(o,n=new s(this,a)),"string"==typeof t&&n[t](i)})},s.NAME=o,e.fn.picker.Constructor=s,e(function(){e('[data-toggle="picker"]').picker()})}(jQuery,window,document);