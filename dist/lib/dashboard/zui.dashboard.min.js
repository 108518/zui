/*!
 * ZUI: 仪表盘 - v1.5.0 - 2017-03-14
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2017 cnezsoft.com; Licensed MIT
 */
!function(e,a,t){"use strict";function i(e,t,i,n){return a.abs((i-e)*(n-t))}function n(e,a,t,i,n,s){return e>=t&&n>=e&&a>=i&&s>=a}function s(e,t,s,o,r,d,l,h){var g=a.max(e,r),p=a.max(t,d),c=a.min(s,l),f=a.min(o,h);return n(g,p,e,t,s,o)&&n(c,f,e,t,s,o)&&n(g,p,r,d,l,h)&&n(c,f,r,d,l,h)?i(g,p,c,f):0}var o=e.zui.Messager?new e.zui.Messager({placement:"top",time:1500,close:0,scale:!1,fade:!1}):0,r=function(a,t){this.$=e(a),this.options=this.getOptions(t),this.draggable=this.$.hasClass("dashboard-draggable")||this.options.draggable,this.init()};r.DEFAULTS={minHeight:100,height:360,shadowType:"normal",sensitive:!1,circleShadowSize:100,onlyRefreshBody:!0,resizable:!0,resizeMessage:!1},r.prototype.getOptions=function(a){return a=e.extend({},r.DEFAULTS,this.$.data(),a)},r.prototype.handleRemoveEvent=function(){var a=this.options.afterPanelRemoved,i=this.options.panelRemovingTip;this.$.on("click",".remove-panel",function(){var n=e(this).closest(".panel"),s=n.data("name")||n.find(".panel-heading").text().replace("\n","").replace(/(^\s*)|(\s*$)/g,""),o=n.attr("data-id");(i===t||i===!1||confirm(i.format(s)))&&(n.parent().remove(),a&&e.isFunction(a)&&a(o))})},r.prototype.handleRefreshEvent=function(){var a=this,t=this.options.onlyRefreshBody;this.$.on("click",".refresh-panel",function(){var i=e(this).closest(".panel");a.refresh(i,t)})},r.prototype.handleDraggable=function(){var t=this.$,n=this.options,o="circle"===n.shadowType,r=n.circleShadowSize,d=r/2,l=n.afterOrdered;this.$.addClass("dashboard-draggable"),this.$.on("mousedown",".panel-actions, .drag-disabled",function(e){e.stopPropagation()});var h;this.$.on("mousedown",".panel-heading, .panel-drag-handler",function(g){function p(t){var o=x.data("mouseOffset");u=t.pageX-o.x,v=t.pageY-o.y,m=u+F,z=v+E,x.css({left:u,top:v}),R.find(".dragging-in").removeClass("dragging-in"),C=!1,b=null;var r,d=0;R.children(":not(.dragging-col)").each(function(){var o=e(this);if(o.hasClass("dragging-col-holder"))return C=!n.sensitive||100>d,!0;var l=o.children(".panel"),h=l.offset(),g=l.width(),p=l.height(),c=h.left,f=h.top;if(n.sensitive)c-=H.left,f-=H.top,r=s(u,v,m,z,c,f,c+g,f+p),r>100&&r>d&&r>a.min(i(u,v,m,z),i(c,f,c+g,f+p))/3&&(d=r,b=o);else{var y=t.pageX,w=t.pageY;if(y>c&&w>f&&c+g>y&&f+p>w)return b=o,!1}}),b&&(y&&clearTimeout(y),w=b,y=setTimeout(c,50)),t.preventDefault()}function c(){w&&(w.addClass("dragging-in"),C?D.insertAfter(w):D.insertBefore(w),t.addClass("dashboard-holding"),y=null,w=null)}function f(a){y&&clearTimeout(y);var i=$.data("order");$.parent().insertAfter(D);var n=0,s={};R.children(":not(.dragging-col-holder)").each(function(){var a=e(this).children(".panel");a.data("order",++n),s[a.data("id")||a.attr("id")]=n,a.parent().attr("data-order",n)}),i!=s[$.data("id")||$.attr("id")]&&(R.data("orders",s),l&&e.isFunction(l)&&l(s)),x.remove(),t.removeClass("dashboard-holding"),t.find(".dragging-col").removeClass("dragging-col"),t.find(".panel-dragging").removeClass("panel-dragging"),R.find(".dragging-in").removeClass("dragging-in"),t.removeClass("dashboard-dragging"),e(document).unbind("mousemove",p).unbind("mouseup",f),a.preventDefault()}var u,v,m,z,y,b,C,w,$=e(this).closest(".panel"),P=$.parent(),R=$.closest(".row"),x=$.clone().addClass("panel-dragging-shadow"),T=$.offset(),H=t.offset(),D=R.find(".dragging-col-holder"),F=$.width(),E=$.height();D.length||(D=e('<div class="dragging-col-holder"><div class="panel"></div></div>').removeClass("dragging-col").appendTo(R)),h&&D.removeClass(h),D.addClass(h=P.attr("class")),D.insertBefore(P).find(".panel").replaceWith($.clone().addClass("panel-dragging panel-dragging-holder")),t.addClass("dashboard-dragging"),$.addClass("panel-dragging").parent().addClass("dragging-col"),x.css({left:T.left-H.left,top:T.top-H.top,width:F,height:E}).appendTo(t).data("mouseOffset",{x:g.pageX-T.left+H.left,y:g.pageY-T.top+H.top}),o&&(x.addClass("circle"),setTimeout(function(){x.css({left:g.pageX-H.left-d,top:g.pageY-H.top-d,width:r,height:r}).data("mouseOffset",{x:H.left+d,y:H.top+d})},100)),e(document).bind("mousemove",p).bind("mouseup",f),g.preventDefault()})},r.prototype.handlePanelPadding=function(){this.$.find(".panel-body > table, .panel-body > .list-group").parent().addClass("no-padding")},r.prototype.updatePanelHeight=function(){var t=this,i=t.options.height,n=t.options.minHeight,s={};return t.id&&e.zui.store&&(s=e.zui.store.pageGet("zui.dashboard."+t.id+".sizeConfig",s)),this.$.children(".row").each(function(){var t=e(this),o=t.width(),r=[],d=[],l=0;t.children(":not(.dragging-col-holder)").each(function(){var a=e(this),t=a.width();l+t>o?(d.length&&r.push(d),d=[a],l=t):(l+=t,d.push(a))}),d.length&&r.push(d),r.length&&e.each(r,function(t){d=r[t];var o=0,l=[],h=!1;e.each(d,function(e){var i=d[e].data("row-id",t),r=i.children(".panel:first");if(l.push(r),!h){var g=r.data("newHeight");if(g)r.data("newHeight",null).data("height",g),o=a.max(n,g),h=!0;else{var p=r.data("height")||s[r.data("id")];p&&(o=a.max(o,p))}}}),o||(o=i),e.each(l,function(e){var a=l[e].css("height",o);s[a.data("id")]=a.data("height")})})}),t.id&&e.zui.store&&e.zui.store.pageSet("zui.dashboard."+t.id+".sizeConfig",s),s},r.prototype.handleResizeEvent=function(){var t=this,i=t.options,n=i.resizable,s=i.onResize,r=i.minHeight,d=i.resizeMessage,l=d&&o;t.$.on("mousedown",".resize-handle",function(i){var n=e(this),d=n.hasClass("resize-vertical"),h=n.parent().addClass("resizing").toggleClass("resizing-v",d).toggleClass("resizing-h",!d),g=h.closest(".row"),p=h.children(".panel"),c=i.pageX,f=i.pageY,u=h.width(),v=p.height(),m=g.width(),z=a.round(12*u/m),y=z;d||h.attr("data-grid",z);var b=function(e){if(d)p.css("height",a.max(r,v+(e.pageY-f)));else{var t=e.pageX,i=a.max(1,a.min(12,a.round(12*(u+(t-c))/m)));y!=i&&(h.attr("data-grid",i).css("width",100*i/12+"%"),l&&o[o.isShow?"update":"show"](a.round(100*i/12)+"% ("+i+"/12)"),y=i)}e.preventDefault(),e.stopPropagation()},C=function(i){if(h.removeClass("resizing resizing-v resizing-h"),d){var n=a.max(r,v+(i.pageY-f));if(n!==v){if(e.isFunction(s)){var g=function(){p.css("height",v).data("height",v),t.updatePanelHeight()},c=s({type:"vertical",id:p.data("id"),element:h,old:v,height:n,revert:g});c===!1&&g()}p.css("height",n).data("newHeight",n)}}else{var u=h.attr("data-grid");if(z!=u&&e.isFunction(s)){var g=function(){h.attr("data-grid",z).css("width",null),t.updatePanelHeight()},c=s({type:"horizontal",id:p.data("id"),element:h,old:z,grid:u,revert:g});c===!1?g():c!==!0&&l&&o.show(a.round(100*u/12)+"% ("+u+"/12)")}}t.updatePanelHeight(),e("body").off("mousemove.resize",b).off("mouseup.resize",C),i.preventDefault(),i.stopPropagation()};e("body").on("mousemove.resize",b).on("mouseup.resize",C),i.preventDefault(),i.stopPropagation()});var h=t.$.children(".row").children(":not(.dragging-col-holder)");(n===!0||"horizontal"===n)&&h.append('<div class="resize-handle resize-horizontal"><i class="icon icon-resize-h"></i></div>'),(n===!0||"vertical"===n)&&h.append('<div class="resize-handle resize-vertical"><i class="icon icon-resize-v"></i></div>')},r.prototype.refresh=function(a,i){i===t&&(i=this.options.onlyRefreshBody);var n=this.options.afterRefresh;a=e(a);var s=a.data("url");s&&(a.addClass("panel-loading").find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").addClass("icon-spin"),e.ajax({url:s,dataType:"html"}).done(function(t){var s=e(t);s.hasClass("panel")?a.empty().append(s.children()):i?a.find(".panel-body").empty().html(t):a.html(t),e.isFunction(n)&&n.call(this,{result:!0,data:t,$panel:a})}).fail(function(){a.addClass("panel-error"),e.isFunction(n)&&n.call(this,{result:!1,$panel:a})}).always(function(){a.removeClass("panel-loading"),a.find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").removeClass("icon-spin")}))},r.prototype.init=function(){var a=this.options,i=this;if(i.id=a.id?a.id:i.$.attr("id"),a.data){var n=e('<div class="row"/>');e.each(a.data,function(a,i){var s=e('<div class="col-sm-'+(i.colWidth||4)+'"/>',i.colAttrs),o=e('<div class="panel" data-id="'+(i.id||e.zui.uuid())+'"/>',i.panelAttrs);if(i.height!==t&&o.data("height",i.height),i.content!==t)if(e.isFunction(i.content)){var r=i.content(o);r!==!0&&o.html(r)}else o.html(i.content);n.append(s.append(o.data("url",i.url)))}),i.$.append(n)}i.updatePanelHeight(),i.handlePanelPadding(),i.handleRemoveEvent(),i.handleRefreshEvent(),a.resizable&&i.handleResizeEvent(),i.draggable&&i.handleDraggable();var s=0;i.$.find(".panel").each(function(){var t=e(this);t.data("order",++s),t.attr("id")||t.attr("id","panel"+s),t.attr("data-id")||t.attr("data-id",s),i.refresh(t,a.onlyRefreshBody)}),i.$.find('[data-toggle="tooltip"]').tooltip({container:"body"})},e.fn.dashboard=function(a){return this.each(function(){var t=e(this),i=t.data("zui.dashboard"),n="object"==typeof a&&a;i||t.data("zui.dashboard",i=new r(this,n)),"string"==typeof a&&i[a]()})},e.fn.dashboard.Constructor=r}(jQuery,Math,void 0);